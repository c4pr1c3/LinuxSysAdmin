<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="é»„ç®" />
  <title>Linuxç³»ç»Ÿä¸ç½‘ç»œç®¡ç†</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Linuxç³»ç»Ÿä¸ç½‘ç»œç®¡ç†</h1>
<p class="author">é»„ç®</p>
</header>
<h1 id="ç•ªå¤–cloud-init">ç•ªå¤–ï¼šCloud-Init</h1>
<hr />
<ul>
<li><code>ansible</code> çš„ä½¿ç”¨å¯¹ç›®æ ‡è¿è¡Œç¯å¢ƒä¹Ÿæœ‰ä¾èµ–è¦æ±‚
<ul>
<li>Python è§£é‡Šå™¨</li>
<li>SSH å…å¯†ç™»å½•</li>
</ul></li>
<li>ä»¥ <code>puppet</code> ä¸ºä»£è¡¨çš„åŸºäº <code>agent</code>
çš„è‡ªåŠ¨åŒ–ç®¡ç†ç³»ç»Ÿæ–¹æ¡ˆéœ€è¦åœ¨ã€ŒåŸºç¡€é•œåƒã€ä¸­æå‰å®‰è£…å¥½å¯¹åº”çš„
<code>agent</code> å¹¶è¿›è¡Œè¿è¡Œæ—¶ç¯å¢ƒç›¸å…³çš„å¿…è¦é…ç½®</li>
</ul>
<hr />
<blockquote>
<p>ä»¥ä¸Šéœ€æ±‚å¯ä»¥é€šè¿‡åœ¨å®šåˆ¶ã€ŒåŸºç¡€é•œåƒã€é˜¶æ®µå°†ä¸Šè¿°ä¾èµ–è½¯ä»¶é¢„è£…åœ¨ç³»ç»Ÿä¸­</p>
</blockquote>
<hr />
<blockquote>
<p>ä½†æ˜¯ï¼Œä¸Šè¿°åšæ³•å¹¶ä¸ã€Œä¼˜é›…ã€ã€‚</p>
</blockquote>
<hr />
<p>ã€ŒåŸºç¡€é•œåƒã€åº”è¯¥æ»¡è¶³ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æœ€å¤§åŒ–ã€Œå¯å¤ç”¨ã€åœºæ™¯ï¼šæœ€å°åŒ–å®‰è£…ç³»ç»Ÿï¼Œåªè£…ã€Œæœ€æ™®ééœ€è¦ã€çš„åŸºç¡€è½¯ä»¶</li>
</ul>
<hr />
<p>è€ƒè™‘ä»¥ä¸‹é›†ç¾¤æœåŠ¡å™¨ç®¡ç†çš„å¸¸è§éœ€æ±‚ï¼š</p>
<ul>
<li>æ–°å®‰è£…çš„ç³»ç»Ÿéœ€è¦é¢„å…ˆé…ç½®ä¸åŒç”¨æˆ·çš„ä¸åŒ SSH å…å¯†ç™»å½•å—ä¿¡ä»»å…¬é’¥</li>
<li>éƒ¨åˆ†æ–°ç³»ç»Ÿéœ€è¦å®‰è£…è½¯ä»¶Aï¼Œå¦ä¸€éƒ¨åˆ†æ–°ç³»ç»Ÿéœ€è¦å®‰è£…è½¯ä»¶B</li>
</ul>
<hr />
<p>ä»¥ä¸Šéœ€æ±‚å¯¹åº”çš„æ“ä½œè¿‡ç¨‹å‡è¦æ±‚ <strong>è‡ªåŠ¨åŒ–</strong> ã€‚</p>
<hr />
<p>è¿™å°±æ˜¯ <code>ä»ä¸€åˆ°äºŒã€åˆ°ä¸‰ï¼Œä¹ƒè‡³ä¸‡ç‰©</code> çš„
<strong>è‡ªåŠ¨åŒ–</strong> é—®é¢˜ã€‚</p>
<hr />
<blockquote>
<p>æ€ä¹ˆè§£å†³ <code>ä»ä¸€åˆ°äºŒã€åˆ°ä¸‰ï¼Œä¹ƒè‡³ä¸‡ç‰©</code> çš„
<strong>è‡ªåŠ¨åŒ–</strong> é—®é¢˜ï¼Ÿ</p>
</blockquote>
<hr />
<h2 id="cloud-init-usage">Cloud-Init çš„ä½œç”¨</h2>
<blockquote>
<p>è§£å†³ <code>ä»ä¸€åˆ°äºŒã€åˆ°ä¸‰ï¼Œä¹ƒè‡³ä¸‡ç‰©</code>
ï¼ˆä»åŸºæœ¬ç³»ç»Ÿåˆ°å¯ç¼–ç¨‹ã€å¯é…ç½®ï¼‰ çš„ <strong>è‡ªåŠ¨åŒ–</strong> é—®é¢˜</p>
</blockquote>
<h1 id="hello-cloud-init">ä»ã€Œç¬¬ä¸€ä¸ª ğŸŒ° ã€å¼€å§‹ä½“éªŒ cloud-init</h1>
<hr />
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># åœ¨åˆ¶ä½œæ— äººå€¼å®ˆå®‰è£…é•œåƒæˆ– PXE é•œåƒæ—¶å°† cloud-init å’Œ openssh-server é¢„è£…</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt install cloud-init genisoimage</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/workspace/cloud-init <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ~/workspace/cloud-init </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> ~/workspace/cloud-init/meta-data</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">instance-id: 1</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">local-hostname: cuc-cloud-init</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> ~/workspace/cloud-init/user-data</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">#cloud-config</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="st">password: mypassword </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="st">chpasswd: { expire: False }</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="st">ssh_pwauth: True</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="ex">genisoimage</span> <span class="at">-output</span> init-cidata.iso <span class="at">-volid</span> cidata <span class="at">-joliet</span> <span class="at">-rock</span> user-data meta-data</span></code></pre></div>
<hr />
<ul>
<li>å°†è™šæ‹Ÿæœºå†…çš„ <code>init-cidata.iso</code> ä¸‹è½½åˆ°å®¿ä¸»æœºç³»ç»Ÿ</li>
<li>åœ¨ Virtualbox çš„å½“å‰è™šæ‹Ÿæœºè®¾ç½®ç•Œé¢æŒ‚è½½
<code>init-cidata.iso</code></li>
</ul>
<p><img src="images/cloud-init/vb-cidata.png" /></p>
<hr />
<p>é‡å¯ <code>å½“å‰è™šæ‹Ÿæœº</code> ï¼Œç™»å½•è¿›å…¥ç³»ç»Ÿåï¼š</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ç³»ç»Ÿçš„ä¸»æœºåå˜æˆäº†ä¸Šè¿°é…ç½®æ–‡ä»¶ç¤ºä¾‹é‡Œçš„ cuc-cloud-init</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># æŸ¥çœ‹ç³»ç»Ÿä¸­ä¼šæ–°å¤šå‡ºä¸€ä¸ªç”¨æˆ· `ubuntu` </span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span> ubuntu</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># è¾“å…¥ä¸Šè¿°é…ç½®æ–‡ä»¶ç¤ºä¾‹é‡Œè®¾ç½®çš„å£ä»¤ `mypassword` </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">su</span> ubuntu</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># æ£€æŸ¥å½“å‰ç”¨æˆ·èº«ä»½</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span></code></pre></div>
<h1 id="è¯¦è§£ä¸Šä¸€ä¸ª">è¯¦è§£ä¸Šä¸€ä¸ªğŸŒ°</h1>
<hr />
<h2 id="user-data">user-data</h2>
<div class="sourceCode" id="cb3"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#cloud-config</span></span></code></pre></div>
<ul>
<li>æ ‡è¯†å½“å‰æ–‡ä»¶æ˜¯ä¸€ä¸ª <code>cloud-config</code>
ç±»å‹æ–‡ä»¶ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç±» <code>User-Data</code></li>
</ul>
<hr />
<div class="sourceCode" id="cb4"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">password</span><span class="kw">:</span><span class="at"> mypassword </span></span></code></pre></div>
<p><code>Ubuntu</code> å‘è¡Œç‰ˆé»˜è®¤åˆ›å»ºçš„ç”¨æˆ·åä¸º
<code>ubuntu</code>ï¼Œæ­¤å¤„ <code>password</code> æŒ‡ä»¤ç­‰ä»·äºå…ˆåˆ›å»ºæ–°ç”¨æˆ·
<code>ubuntu</code> ï¼Œç„¶åè®¾ç½®å£ä»¤ä¸º <code>mypassword</code> ã€‚</p>
<ul>
<li><a
href="https://cloudinit.readthedocs.io/en/latest/topics/modules.html#users-and-groups">users
é…ç½®å…³é”®å­—å®šä¹‰çš„åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·å°±æ˜¯ç³»ç»Ÿçš„é»˜è®¤ç”¨æˆ·ï¼Œå¦‚æœå¸Œæœ›ä¿ç•™å‘è¡Œç‰ˆé»˜è®¤æ ‡å‡†ç”¨æˆ·ååˆ™ç¬¬ä¸€ä¸ªç”¨æˆ·åº”è®¾ç½®ä¸º
default</a> ã€‚</li>
<li>å£ä»¤æ ¼å¼æ—¢å¯ä»¥æ˜¯æ˜æ–‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ <code>mkpasswd</code>
åˆ›å»ºçš„ã€Œå“ˆå¸Œåå£ä»¤ã€ã€‚</li>
</ul>
<hr />
<h2 id="åˆ›å»ºå“ˆå¸Œåå£ä»¤çš„">åˆ›å»ºã€Œå“ˆå¸Œåå£ä»¤ã€çš„ğŸŒ°</h2>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install whois</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mkpasswd</span> <span class="at">-m</span> help <span class="co"># è·å–å½“å‰ç‰ˆæœ¬æ”¯æŒçš„å“ˆå¸Œç®—æ³•</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">mkpasswd</span> <span class="at">-m</span> sha-512 mypassword</span></code></pre></div>
<hr />
<div class="sourceCode" id="cb6"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chpasswd</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">expire</span><span class="kw">:</span><span class="at"> </span><span class="ch">False</span><span class="at"> </span><span class="kw">}</span></span></code></pre></div>
<p><code>chpasswd</code> ç”¨äºå¯¹ç³»ç»Ÿä¸­ <strong>å·²æœ‰</strong>
ç”¨æˆ·æ›´æ”¹å£ä»¤æˆ–è®¾ç½®å£ä»¤å¼ºåˆ¶è¿‡æœŸç­–ç•¥ã€‚æ”¯æŒ <code>expire</code> å’Œ
<code>list</code> å±æ€§ã€‚å…¶ä¸­ <code>list</code> å…³é”®å­—æ”¯æŒ
<code>username:password</code> åˆ—è¡¨å½¢å¼ï¼Œæ—¢å¯ä»¥æ˜¯ <code>YAML list</code>
æ ¼å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ã€Œä¸€è¡Œä¸€é”®å€¼å¯¹ã€çš„ <code>å¤šè¡Œ</code> å­—ç¬¦ä¸²ã€‚</p>
<hr />
<div class="sourceCode" id="cb7"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh_pwauth</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre></div>
<p><code>ssh_pwauth</code> é…ç½® <code>/etc/ssh/sshd_config</code> é‡Œ
<code>PasswordAuthentication</code> å­—æ®µå€¼ã€‚</p>
<h1 id="æ­£å¼å…¥é—¨">æ­£å¼å…¥é—¨</h1>
<hr />
<h2 id="å¿…è¯»å®˜æ–¹æ–‡æ¡£"><a
href="https://cloudinit.readthedocs.io/en/latest/index.html">å¿…è¯»ï¼šå®˜æ–¹æ–‡æ¡£</a></h2>
<ul>
<li>å·¥ä¸šçº§æ ‡å‡†ï¼ˆ<a
href="https://cloudinit.readthedocs.io/en/latest/topics/availability.html">ä¸»æµ
Linux å‘è¡Œç‰ˆã€å…¬æœ‰äº‘æœåŠ¡æä¾›å•†ã€ç§æœ‰äº‘å¹³å°ã€è£¸æœºå®‰è£…</a>ï¼‰</li>
<li>æ”¯æŒä»å¤šç§ã€Œæ•°æ®æºã€åŠ è½½ç”¨æˆ·é…ç½®ï¼Œå®šåˆ¶ä»ã€ŒåŸºç¡€é•œåƒã€åˆ°ã€Œä¸ªæ€§åŒ–å¯ç”¨ç³»ç»Ÿã€çš„è‡ªåŠ¨åŒ–å®ç°</li>
</ul>
<hr />
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>æ”¯æŒçš„å‘è¡Œç‰ˆ</th>
<th>æ”¯æŒçš„å…¬æœ‰äº‘</th>
<th>æ”¯æŒçš„ç§æœ‰äº‘</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ubuntu<br />SLES/openSUSE<br />RHEL/CentOS<br />Fedora<br />Gentoo
Linux<br />Debian<br />ArchLinux<br />FreeBSD<br />NetBSD<br />OpenBSD<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /></td>
<td>Amazon Web Services<br />Microsoft Azure<br />Google Cloud
Platform<br />Oracle Cloud Infrastructure<br />Softlayer<br />Rackspace
Public Cloud<br />IBM Cloud<br />Digital
Ocean<br />Bigstep<br />Hetzner<br />Joyent<br />CloudSigma<br />Alibaba
Cloud<br />OVH<br />OpenNebula<br />Exoscale<br />Scaleway<br />CloudStack<br />AltCloud<br />SmartOS<br />HyperOne<br />Rootbox<br /></td>
<td>Bare metal
installs<br />OpenStack<br />LXD<br />KVM<br />Metal-as-a-Service
(MAAS)<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /></td>
</tr>
</tbody>
</table>
<h1 id="check-cloud-init-version">æŸ¥çœ‹å½“å‰å·²å®‰è£… Cloud-Init ç‰ˆæœ¬</h1>
<hr />
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cloud-init</span> <span class="at">--version</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># /usr/bin/cloud-init 19.4-33-gbb4131a2-0ubuntu1~18.04.1</span></span></code></pre></div>
<p>æ ¹æ®ä»¥ä¸Šç‰ˆæœ¬ä¿¡æ¯ï¼Œæ¨èé˜…è¯»<a
href="https://cloudinit.readthedocs.io/en/19.4/index.html">å®˜æ–¹ v19.4
ç‰ˆæ–‡æ¡£</a> ã€‚</p>
<h1 id="æ•°æ®æº"><a
href="https://cloudinit.readthedocs.io/en/19.4/topics/datasources.html">æ•°æ®æº</a></h1>
<hr />
<ul>
<li>ã€Œæ•°æ®æºã€æŒ‡çš„æ˜¯ <code>cloud-init</code>
çš„é…ç½®æ•°æ®æ¥æºï¼Œé€šå¸¸æ¥è‡ªç”¨æˆ·ï¼ˆä¾‹å¦‚
<code>user-data</code>ï¼‰æˆ–æ¥è‡ªåˆ›å»ºé…ç½®é©±åŠ¨å™¨çš„äº‘ï¼ˆä¾‹å¦‚
<code>meta-data</code> ï¼‰ã€‚</li>
<li>å…¸å‹çš„ã€Œç”¨æˆ·æ•°æ®ã€åŒ…æ‹¬ã€Œæ–‡ä»¶ã€ï¼Œã€Œyamlã€å’Œã€ŒShell è„šæœ¬ã€</li>
<li>å…¸å‹çš„ã€Œå…ƒæ•°æ®ã€åŒ…æ‹¬ã€ŒæœåŠ¡å™¨åç§°ã€ï¼Œã€Œå®ä¾‹
IDã€ï¼Œã€Œæ˜¾ç¤ºåç§°ã€å’Œã€Œå…¶ä»–ç‰¹å®šäºäº‘æœåŠ¡æä¾›å•†ã€çš„è¯¦ç»†ä¿¡æ¯</li>
</ul>
<hr />
<p>å®ä¾‹ï¼ˆInstanceï¼‰åœ¨äº‘è®¡ç®—åœºæ™¯ä¸­ï¼Œä¸€èˆ¬æŒ‡ã€Œäº‘ä¸»æœºå®ä¾‹ã€ã€‚å¯¹äº
<code>Virtualbox</code>
æ¥è¯´ï¼Œæ¯ä¸€ä¸ªæœ¬åœ°è™šæ‹Ÿæœºä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªã€Œå®ä¾‹ã€ã€‚</p>
<hr />
<p>å½“å‰ç³»ç»Ÿä¸Šæ‰§è¡Œè¿‡ <code>Cloud-Init</code> ä¹‹åä¼šå°†ã€Œå…ƒæ•°æ®ã€ä¿å­˜åœ¨
<code>/run/cloud-init/instance-data.json</code> ï¼Œå¦‚ä¸‹æ‰€ç¤ºæ˜¯ã€Œç¬¬ä¸€ä¸ª ğŸŒ°
ã€å¯¹åº”çš„ã€Œå…ƒæ•°æ®ã€ï¼š</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a> <span class="dt">&quot;base64_encoded_keys&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a> <span class="dt">&quot;ds&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;_doc&quot;</span><span class="fu">:</span> <span class="st">&quot;EXPERIMENTAL: The structure and format of content scoped under the &#39;ds&#39; key may change in subsequent releases of cloud-init.&quot;</span><span class="fu">,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;meta_data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>   <span class="dt">&quot;dsmode&quot;</span><span class="fu">:</span> <span class="st">&quot;net&quot;</span><span class="fu">,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>   <span class="dt">&quot;instance-id&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>   <span class="dt">&quot;local-hostname&quot;</span><span class="fu">:</span> <span class="st">&quot;cuc-cloud-init&quot;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">},</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a> <span class="dt">&quot;sensitive_keys&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a> <span class="dt">&quot;v1&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;_beta_keys&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;subplatform&quot;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;availability-zone&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;availability_zone&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;cloud-name&quot;</span><span class="fu">:</span> <span class="st">&quot;unknown&quot;</span><span class="fu">,</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;cloud_name&quot;</span><span class="fu">:</span> <span class="st">&quot;unknown&quot;</span><span class="fu">,</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;instance-id&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span><span class="fu">,</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;instance_id&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span><span class="fu">,</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;local-hostname&quot;</span><span class="fu">:</span> <span class="st">&quot;cuc-cloud-init&quot;</span><span class="fu">,</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;local_hostname&quot;</span><span class="fu">:</span> <span class="st">&quot;cuc-cloud-init&quot;</span><span class="fu">,</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;platform&quot;</span><span class="fu">:</span> <span class="st">&quot;nocloud&quot;</span><span class="fu">,</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;public_ssh_keys&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;region&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;subplatform&quot;</span><span class="fu">:</span> <span class="st">&quot;config-disk (/dev/sr0)&quot;</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a> <span class="fu">}</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<p><a
href="https://cloudinit.readthedocs.io/en/19.4/topics/datasources.html#known-sources">å·²çŸ¥æ”¯æŒæ•°æ®æºç±»å‹</a></p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th>æ’</th>
<th>å</th>
<th>ä¸</th>
<th>åˆ†</th>
<th>å…ˆå</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alibaba Cloud (AliYun)</td>
<td>Alt Cloud</td>
<td>Azure</td>
<td>CloudSigma</td>
<td>CloudStack</td>
</tr>
<tr>
<td>Config Drive</td>
<td>Digital Ocean</td>
<td>E24Cloud</td>
<td>Amazon EC2</td>
<td>Exoscale</td>
</tr>
<tr>
<td>Fallback/None</td>
<td>Google Compute Engine</td>
<td>MAAS</td>
<td><strong>NoCloud</strong></td>
<td>OpenNebula</td>
</tr>
<tr>
<td>OpenStack</td>
<td>Oracle</td>
<td>OVF</td>
<td>Rbx Cloud</td>
<td>SmartOS Datasource</td>
</tr>
<tr>
<td>ZStack</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<hr />
<h2
id="æŸ¥çœ‹æˆ‘ä»¬åœ¨è™šæ‹Ÿæœºé‡Œä½¿ç”¨çš„æ•°æ®æºç±»å‹">æŸ¥çœ‹æˆ‘ä»¬åœ¨è™šæ‹Ÿæœºé‡Œä½¿ç”¨çš„æ•°æ®æºç±»å‹</h2>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cloud-id</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nocloud</span></span></code></pre></div>
<h1 id="nocloud"><a
href="https://cloudinit.readthedocs.io/en/19.4/topics/datasources/nocloud.html#nocloud">NoCloud</a></h1>
<hr />
<p>å›é¡¾ä¹‹å‰æˆ‘ä»¬åˆ›å»º iso é•œåƒæ–‡ä»¶æ—¶ä½¿ç”¨çš„å‘½ä»¤</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">genisoimage</span> <span class="at">-output</span> init-cidata.iso <span class="at">-volid</span> cidata <span class="at">-joliet</span> <span class="at">-rock</span> user-data meta-data</span></code></pre></div>
<ul>
<li><code>-volid cidata</code> æŒ‡å®šæ–°åˆ›å»ºçš„ iso æ–‡ä»¶çš„ã€Œå·æ ‡è¯†ã€ä¸º
<code>cidata</code></li>
</ul>
<p><img src="images/cloud-init/nocloud-cidata.png" /></p>
<hr />
<p>å›é¡¾ä¹‹å‰æˆ‘ä»¬åˆ›å»º iso é•œåƒæ–‡ä»¶æ—¶ä½¿ç”¨çš„å‘½ä»¤</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">genisoimage</span> <span class="at">-output</span> init-cidata.iso <span class="at">-volid</span> cidata <span class="at">-joliet</span> <span class="at">-rock</span> user-data meta-data</span></code></pre></div>
<p><img src="images/cloud-init/nocloud-contents.png" /></p>
<ul>
<li>iso é•œåƒæ–‡ä»¶é‡Œçš„æ–‡ä»¶åå¿…é¡»æ˜¯ <code>user-data</code> å’Œ
<code>meta-data</code></li>
</ul>
<hr />
<p>å›é¡¾ä¹‹å‰çš„ <code>meta-data</code> æ–‡ä»¶å†…å®¹</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">instance-id</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">local-hostname</span><span class="kw">:</span><span class="at"> cuc-cloud-init</span></span></code></pre></div>
<p>å…¶ä¸­ <code>instance-id: 1</code> ç”¨æ¥å‘Šè¯‰ <code>cloud-init</code>
å¼•æ“è¯¥å®ä¾‹ã€Œæ˜¯å¦é¦–æ¬¡å¯åŠ¨ã€ã€‚</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># æŸ¥çœ‹è¯¥å®ä¾‹å¯åŠ¨è¿‡ä¸€æ¬¡ä¹‹ååœ¨å½“å‰ç³»ç»Ÿå†…ç•™ä¸‹çš„ç—•è¿¹</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> /var/lib/cloud/instances/1/</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># boot-finished     datasource  obj.pkl  sem            user-data.txt.i  vendor-data.txt.i</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># cloud-config.txt  handlers    scripts  user-data.txt  vendor-data.txt</span></span></code></pre></div>
<hr />
<p>å…¶ä¸­ <code>boot-finished</code>
æ–‡ä»¶è®°å½•äº†è¯¥å®ä¾‹å®šä¹‰çš„å¯åŠ¨æ—¶é—´ï¼Œä¾‹å¦‚ï¼š</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /var/lib/cloud/instances/1/boot-finished</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 11.28 - Tue, 14 Apr 2020 07:33:47 +0000 - v. 19.4-33-gbb4131a2-0ubuntu1~18.04.1</span></span></code></pre></div>
<hr />
<p>å½“ä¸Šè¿°ç›®å½•ç»“æ„å­˜åœ¨æ—¶ï¼Œåªè¦ <code>init-cidata.iso</code>
å†…å®¹ä¸å˜ã€‚å³ä½¿ä¸€ç›´æŒ‚è½½åœ¨è™šæ‹Ÿæœºçš„å…‰é©±é‡Œï¼Œæ¯æ¬¡å¯åŠ¨è™šæ‹Ÿæœºç³»ç»Ÿæ—¶ï¼Œä¹Ÿä¸ä¼šå†é‡æ–°æ‰§è¡Œä¸€éå…‰ç›˜é‡Œå®šä¹‰çš„
<code>cloud-init</code> æ“ä½œäº†ã€‚</p>
<hr />
<p>å¦‚æœå¸Œæœ›é‡æ–°æ‰§è¡Œ <code>init-cidata.iso</code> é‡Œå®šä¹‰çš„æ“ä½œï¼Œéœ€è¦å˜æ›´
<code>meta-data</code> æ–‡ä»¶é‡Œçš„ <code>instance-id</code> èµ‹å€¼ä¸º
<code>/var/lib/cloud/instances/</code> ä¸‹ä¸å­˜åœ¨é‡åå­ç›®å½•çš„å…¶ä»–å€¼ã€‚</p>
<h1 id="debug-user-data"><a
href="https://cloudinit.readthedocs.io/en/19.4/topics/faq.html#how-can-i-debug-my-user-data">è°ƒè¯•
user-data</a></h1>
<hr />
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># éªŒè¯ user-data æ–‡ä»¶æ˜¯å¦å­˜åœ¨è¯­æ³•é”™è¯¯</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cloud-init</span> devel schema <span class="at">-c</span> user-data <span class="at">--annotate</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid cloud-config file user-data</span></span></code></pre></div>
<h1 id="è®¤è¯†æ¨¡å—">è®¤è¯†æ¨¡å—</h1>
<hr />
<ul>
<li><a
href="https://cloudinit.readthedocs.io/en/19.4/topics/cli.html#modules">/etc/cloud/cloud.cfg</a>
ä¸­å®šä¹‰äº†å½“å‰ç³»ç»Ÿä¸­ <code>Cloud-Init</code>
åœ¨ã€Œä¸åŒé˜¶æ®µã€åŠ è½½äº†å“ªäº›æ¨¡å—ã€‚</li>
</ul>
<hr />
<h2 id="boot-stages"><a
href="https://cloudinit.readthedocs.io/en/19.4/topics/boot.html">Cloud-Init
ä¸»è¦é˜¶æ®µ</a></h2>
<p>ç»“åˆ <code>/etc/cloud/cloud.cfg</code>
æ–‡ä»¶å†…å®¹æ¥ç†è§£ä¸åŒã€Œå¯åŠ¨é˜¶æ®µã€ï¼šæ–‡ä»¶ä¸­ä¸€å…±å®šä¹‰äº† 3 ä¸ªé˜¶æ®µ:</p>
<ul>
<li>init</li>
<li>config</li>
<li>final</li>
</ul>
<p>æ¯ä¸ªé˜¶æ®µå¯ä»¥ã€Œå®Œæˆã€å“ªäº›æ“ä½œå¯ä»¥æ ¹æ®åŒ…å«çš„ã€Œæ¨¡å—ã€åŠŸèƒ½çŸ¥æ‚‰ã€‚</p>
<hr />
<p><code>/etc/cloud/cloud.cfg</code> ğŸŒ°</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ref: https://cloudinit.readthedocs.io/en/19.4/topics/modules.html</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ä»¥ä¸‹å„ä¸ªé˜¶æ®µå®šä¹‰çš„ã€Œæ¨¡å—ã€å‡åœ¨ä»¥ä¸Šå®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¯¦ç»†ä½¿ç”¨è¯´æ˜</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The modules that run in the &#39;init&#39; stage</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cloud_init_modules</span><span class="kw">:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> migrator</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> seed_random</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> bootcmd</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> write-files</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> growpart</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> resizefs</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> disk_setup</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> mounts</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> set_hostname</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> update_hostname</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> update_etc_hosts</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> ca-certs</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> rsyslog</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> users-groups</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> ssh</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"># The modules that run in the &#39;config&#39; stage</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="fu">cloud_config_modules</span><span class="kw">:</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Emit the cloud config ready event</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co"># this can be used by upstart jobs for &#39;start on cloud-config&#39;.</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> emit_upstart</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> snap</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> ssh-import-id</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> locale</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> set-passwords</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> grub-dpkg</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> apt-pipelining</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> apt-configure</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> ubuntu-advantage</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> ntp</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> timezone</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> disable-ec2-metadata</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> runcmd</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> byobu</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="co"># The modules that run in the &#39;final&#39; stage</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="fu">cloud_final_modules</span><span class="kw">:</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> package-update-upgrade-install</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> fan</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> landscape</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> lxd</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> ubuntu-drivers</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> puppet</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> chef</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> mcollective</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> salt-minion</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> rightscale_userdata</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> scripts-vendor</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> scripts-per-once</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> scripts-per-boot</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> scripts-per-instance</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> scripts-user</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> ssh-authkey-fingerprints</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> keys-to-console</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> phone-home</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> final-message</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> power-state-change</span></span></code></pre></div>
<hr />
<p>ç»“åˆ <a
href="https://cloudinit.readthedocs.io/en/19.4/topics/boot.html">å®˜æ–¹æ–‡æ¡£é‡Œã€Œå¯åŠ¨é˜¶æ®µã€</a>
ä¸€èŠ‚çš„æè¿°å¯çŸ¥ï¼š<code>init</code> é˜¶æ®µåˆå¯ä»¥åˆ†ä¸ºï¼š</p>
<ul>
<li>Generator</li>
<li>Local</li>
<li>Network</li>
</ul>
<h1 id="ç†è§£æ¨¡å—">ç†è§£æ¨¡å—</h1>
<hr />
<p>ç›¸å½“äºã€Œå¯¼å…¥å‡½æ•°ã€æˆ–ã€Œå¯¼å…¥åº“ã€çš„ä½œç”¨ï¼Œå¦‚æœåœ¨æŒ‡å®šã€Œå¯åŠ¨é˜¶æ®µã€æ²¡æœ‰ã€Œå®šä¹‰ã€ä½¿ç”¨æŸä¸ªã€Œæ¨¡å—ã€ï¼Œåˆ™åœ¨
<code>user-data</code> ä¸­ä¸èƒ½è°ƒç”¨ç›¸åº”æŒ‡ä»¤ã€‚</p>
<hr />
<p>å†å›çœ‹ã€Œç¬¬ä¸€ä¸ª ğŸŒ° ã€</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#cloud-config</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">password</span><span class="kw">:</span><span class="at"> mypassword </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chpasswd</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">expire</span><span class="kw">:</span><span class="at"> </span><span class="ch">False</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh_pwauth</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre></div>
<p>ä¸Šè¿° 3 ä¸ªé…ç½®æŒ‡ä»¤ <code>password</code>, <code>chpasswd</code>,
<code>ssh_pwauth</code> å‡å®šä¹‰åœ¨ <a
href="https://cloudinit.readthedocs.io/en/latest/topics/modules.html#set-passwords">set-passwords</a>
æ¨¡å—ä¸­ã€‚</p>
<h1 id="ç†è§£ç¼ºçœè®¾ç½®">ç†è§£ç¼ºçœè®¾ç½®</h1>
<hr />
<div class="sourceCode" id="cb19"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The top level settings are used as module</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and system configuration.</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># A set of users which may be applied and/or used by various modules</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># when a &#39;default&#39; entry is found it will reference the &#39;default_user&#39;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># from the distro configuration specified below</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">users</span><span class="kw">:</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> default</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># If this is set, &#39;root&#39; will not be able to ssh in and they</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># will get a message to login instead as the default $user</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="fu">disable_root</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># This will cause the set+update hostname module to not operate (if true)</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="fu">preserve_hostname</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Example datasource config</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># datasource:</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#    Ec2:</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#      metadata_urls: [ &#39;blah.com&#39; ]</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">#      timeout: 5 # (defaults to 50 seconds)</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#      max_wait: 10 # (defaults to 120 seconds)</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co"># æ­¤å¤„çœç•¥ 3 ä¸ªé˜¶æ®µçš„æ¨¡å—å®šä¹‰ç›¸å…³æŒ‡ä»¤</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co"># System and/or distro specific settings</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co"># (not accessible to handlers/transforms)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="fu">system_info</span><span class="kw">:</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">   # This will affect which distro class gets used</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">distro</span><span class="kw">:</span><span class="at"> ubuntu</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co">   # Default user name + that default users groups (if added/used)</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">default_user</span><span class="kw">:</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="fu">name</span><span class="kw">:</span><span class="at"> ubuntu</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="fu">lock_passwd</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="fu">gecos</span><span class="kw">:</span><span class="at"> Ubuntu</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="fu">groups</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">adm</span><span class="kw">,</span><span class="at"> audio</span><span class="kw">,</span><span class="at"> cdrom</span><span class="kw">,</span><span class="at"> dialout</span><span class="kw">,</span><span class="at"> dip</span><span class="kw">,</span><span class="at"> floppy</span><span class="kw">,</span><span class="at"> lxd</span><span class="kw">,</span><span class="at"> netdev</span><span class="kw">,</span><span class="at"> plugdev</span><span class="kw">,</span><span class="at"> sudo</span><span class="kw">,</span><span class="at"> video</span><span class="kw">]</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="fu">sudo</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;ALL=(ALL) NOPASSWD:ALL&quot;</span><span class="kw">]</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> /bin/bash</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="co">   # Automatically discover the best ntp_client</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">ntp_client</span><span class="kw">:</span><span class="at"> auto</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co">   # Other config here will be given to the distro class and/or path classes</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">cloud_dir</span><span class="kw">:</span><span class="at"> /var/lib/cloud/</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">templates_dir</span><span class="kw">:</span><span class="at"> /etc/cloud/templates/</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">upstart_dir</span><span class="kw">:</span><span class="at"> /etc/init/</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">package_mirrors</span><span class="kw">:</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="kw">-</span><span class="at"> </span><span class="fu">arches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">i386</span><span class="kw">,</span><span class="at"> amd64</span><span class="kw">]</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="at">       </span><span class="fu">failsafe</span><span class="kw">:</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">primary</span><span class="kw">:</span><span class="at"> http://archive.ubuntu.com/ubuntu</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">security</span><span class="kw">:</span><span class="at"> http://security.ubuntu.com/ubuntu</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="at">       </span><span class="fu">search</span><span class="kw">:</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">primary</span><span class="kw">:</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="at">           </span><span class="kw">-</span><span class="at"> http://%(ec2_region)s.ec2.archive.ubuntu.com/ubuntu/</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="at">           </span><span class="kw">-</span><span class="at"> http://%(availability_zone)s.clouds.archive.ubuntu.com/ubuntu/</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="at">           </span><span class="kw">-</span><span class="at"> http://%(region)s.clouds.archive.ubuntu.com/ubuntu/</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">security</span><span class="kw">:</span><span class="at"> </span><span class="kw">[]</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="kw">-</span><span class="at"> </span><span class="fu">arches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">arm64</span><span class="kw">,</span><span class="at"> armel</span><span class="kw">,</span><span class="at"> armhf</span><span class="kw">]</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a><span class="at">       </span><span class="fu">failsafe</span><span class="kw">:</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">primary</span><span class="kw">:</span><span class="at"> http://ports.ubuntu.com/ubuntu-ports</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">security</span><span class="kw">:</span><span class="at"> http://ports.ubuntu.com/ubuntu-ports</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="at">       </span><span class="fu">search</span><span class="kw">:</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">primary</span><span class="kw">:</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="at">           </span><span class="kw">-</span><span class="at"> http://%(ec2_region)s.ec2.ports.ubuntu.com/ubuntu-ports/</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="at">           </span><span class="kw">-</span><span class="at"> http://%(availability_zone)s.clouds.ports.ubuntu.com/ubuntu-ports/</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="at">           </span><span class="kw">-</span><span class="at"> http://%(region)s.clouds.ports.ubuntu.com/ubuntu-ports/</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">security</span><span class="kw">:</span><span class="at"> </span><span class="kw">[]</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="at">     </span><span class="kw">-</span><span class="at"> </span><span class="fu">arches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">default</span><span class="kw">]</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a><span class="at">       </span><span class="fu">failsafe</span><span class="kw">:</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">primary</span><span class="kw">:</span><span class="at"> http://ports.ubuntu.com/ubuntu-ports</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a><span class="at">         </span><span class="fu">security</span><span class="kw">:</span><span class="at"> http://ports.ubuntu.com/ubuntu-ports</span></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">ssh_svcname</span><span class="kw">:</span><span class="at"> ssh</span></span></code></pre></div>
<h1 id="cloud-init-real-example">cloud-init å®æˆ˜ ğŸŒ°</h1>
<hr />
<h2 id="éœ€æ±‚æè¿°">éœ€æ±‚æè¿°</h2>
<ol type="1">
<li>é‡ç½® <a
href="https://www.freedesktop.org/software/systemd/man/machine-id.html">machine-id</a></li>
<li>æ·»åŠ  ssh å…å¯†ç™»å½•</li>
<li>å®‰è£… python3</li>
</ol>
<h1 id="why-reset-machine-id">ä¸ºä»€ä¹ˆéœ€è¦é‡ç½®
<code>machine-id</code></h1>
<hr />
<h2 id="machine-id-1">machine-id</h2>
<blockquote>
<p>The <code>/etc/machine-id</code> file contains the unique machine ID
of the local system that is set during installation or boot. The machine
ID is a single newline-terminated, hexadecimal, 32-character, lowercase
ID. When decoded from hexadecimal, this corresponds to a 16-byte/128-bit
value. This ID may not be all zeros.</p>
</blockquote>
<hr />
<h2 id="machine-id-2">machine-id</h2>
<blockquote>
<p>systemd-machine-id-setup(1) may be used by installer tools to
initialize the machine ID at install time, but /etc/machine-id may also
be written using any other means.</p>
</blockquote>
<hr />
<h2 id="machine-id-3">machine-id</h2>
<blockquote>
<p>For operating system images which are created once and used on
multiple machines, for example for containers or in the cloud,
<code>/etc/machine-id</code> <strong>should be an empty file</strong> in
the generic file system image.
<code>An ID will be generated during boot and saved to this file if possible</code>.
<strong>Having an empty file</strong> in place is useful because it
allows a temporary file to be bind-mounted over the real file, in case
the image is used read-only.</p>
</blockquote>
<hr />
<h2 id="machine-id-4">machine-id</h2>
<blockquote>
<p>å¯¹äº Debian åŠå…¶è¡ç”Ÿå‘è¡Œç‰ˆï¼Œä¾‹å¦‚ Kali
ï¼Œä»¥ä¸Šæ“ä½œæ­¥éª¤å‡å¯èƒ½å¤±æ•ˆï¼šæ— æ³•æ›´æ–° /etc/machine-id ã€‚</p>
</blockquote>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Virtualbox çš„å¤šé‡åŠ è½½é•œåƒæœºåˆ¶å…‹éš†å‡ºæ¥çš„è™šæ‹Ÿæœºä½¿ç”¨çš„è™šæ‹Ÿç£ç›˜ï¼Œç£ç›˜ uuid å€¼æ˜¯ç›¸åŒçš„</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> blkid /dev/sda1</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># /dev/sda1: UUID=&quot;dff30eeb-7332-438d-964c-d5c7f4d357f7&quot; BLOCK_SIZE=&quot;4096&quot; TYPE=&quot;ext4&quot; PARTUUID=&quot;f0f6b9b0-01&quot;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-l</span> /dev/disk/by-uuid</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># lrwxrwxrwx 1 root root 10 Dec  3 00:32 dff30eeb-7332-438d-964c-d5c7f4d357f7 -&gt; ../../sda1</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/machine-id çš„å€¼ä¸ç£ç›˜ uuid å€¼æ— å…³</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># å±€åŸŸç½‘ä¸­ï¼Œã€ä¸åŒä¸»æœºã€‘çš„ç£ç›˜åˆ†åŒº uuid å€¼ç›¸åŒæ— å½±å“ï¼Œä½†è¦é¿å… machine-id å€¼é‡å¤</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># machine-id é‡å¤çš„ä¸€ä¸ªæœ€ç›´æ¥å½±å“æ˜¯å¯¹äºä½¿ç”¨ Net-Plan æ–¹å¼è¿›è¡Œ DHCP è·å– IP åœ°å€çš„å®¢æˆ·ç«¯æ¥è¯´ï¼Œç¼ºçœ DHCP è¯·æ±‚ç­–ç•¥ä¼šå¯¼è‡´å±€åŸŸç½‘ä¸­å‡ºç° IP åœ°å€å†²çª</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># é™¤æ­¤ä¹‹å¤–ï¼Œå¯¹äºåˆ†å¸ƒå¼é›†ç¾¤ç³»ç»Ÿæ¥è¯´ï¼Œé‡å¤ machine-id å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä¸ç¡®å®šæ€§é”™è¯¯</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ref-1: https://unix.stackexchange.com/questions/402999/is-it-ok-to-change-etc-machine-id</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ref-2: https://documentation.suse.com/external-tree/en-us/suma/4.0/suse-manager/administration/tshoot-registerclones.html</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># TL;DR å¯¹äº Debian åŠå…¶è¡ç”Ÿå‘è¡Œç‰ˆç³»ç»Ÿ /etc/machine-id çš„å€¼æ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ‹·è´è‡ª /var/lib/dbus/machine-id</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rm /var/lib/dbus/machine-id /etc/machine-id</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">## ref-1 çš„æ–¹æ³•</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> dbus-uuidgen <span class="at">--ensure</span><span class="op">=</span>/etc/machine-id</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ä» /etc/machine-id æ‹·è´å†…å®¹åˆ° /var/lib/dbus/machine-id</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> dbus-uuidgen <span class="at">--ensure</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co">## ref-2 çš„æ–¹æ³•</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co"># å½“ /etc/machine-id å†…å®¹ä¸ºç©ºæˆ–æ–‡ä»¶ç¼ºå¤±æ—¶ï¼Œåˆ›å»º /var/lib/dbus/machine-id å¹¶å†™å…¥ machine-id</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> dbus-uuidgen <span class="at">--ensure</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ä» /var/lib/dbus/machine-id æ‹·è´å†…å®¹åˆ° /etc/machine-id</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemd-machine-id-setup</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ä»¥ä¸Š ref-1 å’Œ ref-2 çš„æ–¹æ³•åœ¨ Kali ä¸Šæ•ˆæœç›¸åŒ</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co"># éªŒè¯ machine-id</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/machine-id</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /var/lib/dbus/machine-id</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="co"># é‡å¯ç³»ç»Ÿï¼Œä»¥ç¡®ä¿é…ç½®å˜æ›´ç”Ÿæ•ˆ</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> reboot</span></code></pre></div>
<hr />
<h2
id="ä¸ºä»€ä¹ˆæˆ‘å…‹éš†å‡ºæ¥çš„è™šæ‹Ÿæœºæ€»æ˜¯è·å¾—ç›¸åŒ-ip-åœ°å€">ä¸ºä»€ä¹ˆæˆ‘å…‹éš†å‡ºæ¥çš„è™šæ‹Ÿæœºæ€»æ˜¯è·å¾—ç›¸åŒ
IP åœ°å€ï¼Ÿ</h2>
<p>æ ¹æ®<a href="https://unix.stackexchange.com/a/419322">ç½‘å‹
<code>wickedchicken</code> åœ¨ SO ç½‘ç«™ä¸Šçš„å›ç­”</a></p>
<blockquote>
<p><code>systemd-networkd</code> uses a different method to generate the
DUID than <code>dhclient</code>. <code>dhclient</code> <a
href="https://manpages.debian.org/jessie/isc-dhcp-client/dhclient.8.en.html">by
default uses the link-layer address</a> while systemd-networkd uses <a
href="https://www.freedesktop.org/software/systemd/man/networkd.conf.html#DUIDType=">the
contents of /etc/machine-id</a>. Since the VMs were cloned, they have
the same <code>machine-id</code> and the DHCP server returns the same IP
for both.</p>
</blockquote>
<hr />
<blockquote>
<p>To fix, replace the contents of one or both of /etc/machine-id. This
can be anything, but deleting the file and running
systemd-machine-id-setup will create a random machine-id in the same way
done on machine setup.</p>
</blockquote>
<hr />
<p>å¦ä¸€ç§è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹ <code>/etc/netplan/01-netcfg.yaml</code>
ï¼Œåœ¨ç½‘å¡çš„ <code>dhcp</code> é…ç½®åˆ—è¡¨é‡Œæ·»åŠ é…ç½®å‚æ•°ï¼š<a
href="https://netplan.io/reference">dhcp-identifier: mac</a></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ref: https://netplan.io/examples#integration-with-a-windows-dhcp-server</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">network</span><span class="kw">:</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ethernets</span><span class="kw">:</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">enp0s3</span><span class="kw">:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">dhcp4</span><span class="kw">:</span><span class="at"> </span><span class="ch">yes</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">enp8s0</span><span class="kw">:</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">dhcp4</span><span class="kw">:</span><span class="at"> </span><span class="ch">yes</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">dhcp-identifier</span><span class="kw">:</span><span class="at"> mac</span></span></code></pre></div>
<hr />
<h2 id="reboot-after-machine-id-reset">å˜æ›´ <code>machine-id</code>
ä¹‹åä¸ºä»€ä¹ˆéœ€è¦é‡å¯</h2>
<p>ä»¥ä¸‹å†…å®¹æ‘˜è‡ª <code>man dbus-uuidgen</code></p>
<blockquote>
<p>If you try to change an existing machine-id on a running system, it
will probably result in bad things happening. Donâ€™t try to change this
file. Also, donâ€™t make it the same on two different systems; it needs to
be different anytime there are two different kernels running.</p>
</blockquote>
<hr />
<p>ä»¥ä¸‹ç»“è®ºæ‘˜è‡ª <a href="https://unix.stackexchange.com/a/403054">ç½‘å‹
<code>hvd</code> åœ¨ SO ç½‘ç«™ä¸Šçš„å›ç­”ç»“è®º</a> ï¼š</p>
<blockquote>
<p><strong>So after doing this, definitely donâ€™t continue using the
system without rebooting.</strong></p>
</blockquote>
<h1 id="cloud-init-real-example-get-started">cloud-init å®æˆ˜ ğŸŒ°
é©¬ä¸Šå¼€å§‹</h1>
<hr />
<ol type="1">
<li>ç¡®ä¿ç›®æ ‡ç³»ç»Ÿå†…å·²å®‰è£… <code>cloud-init</code></li>
<li>æ£€æŸ¥ <code>/etc/machine-id</code> æ­¤æ—¶çš„å€¼</li>
<li>æ£€æŸ¥ <code>/etc/netplan/</code> ç›®å½•ä¸‹æ­¤æ—¶çš„æ–‡ä»¶</li>
<li>æ£€æŸ¥ <code>/etc/netplan/01-netcfg.yaml</code> æ–‡ä»¶å†…å®¹</li>
<li>æ£€æŸ¥å½“å‰ç¬¬äºŒå—ç½‘å¡çš„ IP åœ°å€</li>
</ol>
<hr />
<h2 id="å…³é”®é…ç½®">å…³é”®é…ç½®</h2>
<ul>
<li><code>user-data</code></li>
<li><code>meta-data</code></li>
</ul>
<hr />
<h3 id="user-data-real-example"><code>user-data</code> ç¤ºä¾‹</h3>
<div class="sourceCode" id="cb22"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#cloud-config</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">users</span><span class="kw">:</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cuc</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">lock_passwd</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span><span class="co"> # Disable password login. Default: true</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">passwd</span><span class="kw">:</span><span class="at"> </span><span class="dv">123456</span><span class="co"> # !!DEMO only!! Hashed password is recommended in Production.</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ssh_authorized_keys</span><span class="kw">:</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> &lt;ssh-pub-key-1&gt;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> &lt;ssh-pub-key-2&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># run the following cmds after system is booted and rootfs is mounted</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">runcmd</span><span class="kw">:</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> echo -n &#39;&#39; &gt; /etc/machine-id</span><span class="co"> # clear but not delete</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /bin/systemd-machine-id-setup</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Install additional packages on first boot</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Default: none</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co"># if packages are specified, this apt_update will be set to true</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co"># packages may be supplied as a single package name or as a list</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co"># with the format [&lt;package&gt;, &lt;version&gt;] wherein the specifc</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co"># package version will be installed.</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="fu">packages</span><span class="kw">:</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python3</span><span class="co"> # required by ansible remote </span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co">## poweroff or reboot system after finished</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co"># default: none</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co"># power_state can be used to make the system shutdown, reboot or</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co"># halt after boot is finished.  This same thing can be acheived by</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co"># user-data scripts or by runcmd by simply invoking &#39;shutdown&#39;.</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Doing it this way ensures that cloud-init is entirely finished with</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co"># modules that would be executed, and avoids any error/log messages</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co"># that may go to the console as a result of system services like</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co"># syslog being taken down while cloud-init is running.</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="co"># If you delay &#39;+5&#39; (5 minutes) and have a timeout of</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 120 (2 minutes), then the max time until shutdown will be 7 minutes.</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="co"># cloud-init will invoke &#39;shutdown +5&#39; after the process finishes, or</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="co"># when &#39;timeout&#39; seconds have elapsed.</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="co"># delay: form accepted by shutdown.  default is &#39;now&#39;. other format</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co">#        accepted is +m (m in minutes)</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="co"># mode: required. must be one of &#39;poweroff&#39;, &#39;halt&#39;, &#39;reboot&#39;</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co"># message: provided as the message argument to &#39;shutdown&#39;. default is none.</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="co"># timeout: the amount of time to give the cloud-init process to finish</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="co">#          before executing shutdown.</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a><span class="co"># condition: apply state change only if condition is met.</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="co">#            May be boolean True (always met), or False (never met),</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="co">#            or a command string or list to be executed.</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="co">#            command&#39;s exit code indicates:</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="co">#               0: condition met</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="co">#               1: condition not met</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="co">#            other exit codes will result in &#39;not met&#39;, but are reserved</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="co">#            for future use.</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="fu">power_state</span><span class="kw">:</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="fu">delay</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;now&quot;</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="fu">mode</span><span class="kw">:</span><span class="at"> reboot</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="fu">message</span><span class="kw">:</span><span class="at"> Make new machine-id take effect</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="at"> </span><span class="fu">condition</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre></div>
<hr />
<h3 id="meta-data-real-example"><code>meta-data</code> ç¤ºä¾‹</h3>
<div class="sourceCode" id="cb23"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">instance-id</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">local-hostname</span><span class="kw">:</span><span class="at"> ansible-slave</span></span></code></pre></div>
<hr />
<h2 id="å®éªŒå®Œæˆåæ£€æŸ¥æ¸…å•">å®éªŒå®Œæˆåæ£€æŸ¥æ¸…å•</h2>
<ol type="1">
<li>æ£€æŸ¥ <code>/etc/machine-id</code> æ­¤æ—¶çš„å€¼</li>
<li>æ£€æŸ¥ <code>/etc/netplan/</code> ç›®å½•ä¸‹æ­¤æ—¶çš„æ–‡ä»¶</li>
<li>æ£€æŸ¥å½“å‰ç¬¬äºŒå—ç½‘å¡çš„ IP åœ°å€</li>
</ol>
<h1 id="more-examples">æ›´å¤æ‚çš„ ğŸŒ° ä»¬</h1>
<hr />
<p><a
href="https://cloudinit.readthedocs.io/en/19.4/topics/examples.html">å®˜æ–¹æ–‡æ¡£ä¸­ç»™å‡ºçš„æ›´å¤š
cloud-config é…ç½®æ–‡ä»¶ç¤ºä¾‹</a></p>
</body>
</html>
